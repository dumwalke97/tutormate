<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor Mate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            /* Switched to a standard system font for better compatibility */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .font-playfair { /* Renamed to font-title for clarity, but keeping original for diff */
            font-family: 'Nunito', sans-serif;
            font-weight: 800; /* ExtraBold */
        }
        .quiz-option.correct {
            background-color: #22c55e !important; /* green-500 */
            color: white !important;
            border-color: #16a34a !important; /* green-600 */
        }
        .quiz-option.incorrect {
            background-color: #ef4444 !important; /* red-500 */
            color: white !important;
            border-color: #dc2626 !important; /* red-600 */
        }
        /* Styles for the review section to avoid overriding icon colors */
        #review-container .correct {
            background-color: #dcfce7; /* green-100 */
            border: 1px solid #22c55e; /* green-500 */
        }
        #review-container .incorrect {
            background-color: #fee2e2; /* red-100 */
            border: 1px solid #ef4444; /* red-500 */
        }
        /* Simple fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Thumbnail styling */
        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb; /* gray-200 */
        }
        .dark .thumbnail {
             border: 2px solid #475569; /* slate-600 */
        }
        .thumbnail-container {
            position: relative;
            display: inline-block;
        }
        .delete-btn {
            position: absolute;
            top: -12px;  /* Adjusted position for new size */
            right: -12px; /* Adjusted position for new size */
            background-color: #ef4444; /* red-500 */
            color: white; 
            border-radius: 9999px; /* full */
            width: 32px;  /* Increased size for easier tapping */
            height: 32px; /* Increased size for easier tapping */
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            cursor: pointer;
            line-height: 1; 
            transition: background-color 0.2s ease-in-out;
        }
        .delete-btn:hover {
            background-color: #dc2626; /* red-600 */
        }
        /* Style for assignment feedback */
        #assignment-feedback-container {
            white-space: pre-wrap; /* Allows text to wrap and respects newlines */
            text-align: left;
            background-color: #f8fafc; /* slate-50 */
            border-radius: 0.5rem;
            padding: 1rem;
            max-height: 50vh;
            overflow-y: auto;
        }
        .dark #assignment-feedback-container {
            background-color: #1e293b; /* slate-800 */
        }
    </style>
</head>
<body class="bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <div id="main-container" class="bg-slate-200 dark:bg-slate-800 rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-500">

            <!-- Initial Upload State -->
            <div id="upload-state">
                <div class="text-center">
                    <h1 class="text-4xl font-bold text-indigo-800 dark:text-sky-300 font-playfair">Tutor Mate</h1>
                    <p class="text-slate-500 dark:text-slate-400 mt-2">Upload a worksheet to get started.</p>
                </div>

                <div id="multi-image-preview-container" class="mt-6 p-2 w-full bg-white dark:bg-slate-700 rounded-lg flex-wrap gap-3 justify-center border-2 border-dashed border-slate-400 dark:border-slate-600 hidden">
                    <!-- Thumbnails will be added here -->
                </div>
                
                <div class="mt-6 text-center" id="upload-prompt">
                    <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3 3m3-3l3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.33-2.33 3 3 0 013.75 5.25" />
                    </svg>
                    <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Upload files or use your camera</p>
                </div>

                <input type="file" id="image-upload" class="hidden" accept="image/*" multiple>
                
                <label for="image-upload" id="upload-button" class="mt-6 w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-800 hover:bg-indigo-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-700 cursor-pointer transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>Add Images/Files</span>
                </label>

                <button id="check-assignment-btn" class="hidden mt-4 w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-sky-500 hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5">
                    Check Assignment
                </button>

                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-300 dark:border-slate-600"></div></div>
                    <div class="relative flex justify-center"><span class="bg-slate-200 dark:bg-slate-800 px-2 text-sm text-slate-500 dark:text-slate-400">Or</span></div>
                </div>
                
                <div class="space-y-4">
                     <div>
                        <label for="custom-prompt" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Create a quiz from a topic:</label>
                        <textarea id="custom-prompt" name="custom-prompt" rows="3" class="mt-1 block w-full shadow-sm sm:text-sm border-2 border-slate-400 dark:bg-slate-700 dark:border-slate-600 rounded-md focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., 'US State Capitals' or '10th Grade Biology Photosynthesis'"></textarea>
                    </div>
                    <div>
                        <label for="question-count" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Number of Questions:</label>
                        <select id="question-count" name="question-count" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-400 dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md">
                            <option>5</option>
                            <option selected>10</option>
                            <option>15</option>
                            <option>20</option>
                            <option>25</option>
                            <option>30</option>
                        </select>
                    </div>

                    <button id="generate-quiz-btn" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-800 hover:bg-indigo-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-700 transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5">
                        Generate Quiz
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center p-8 hidden">
                <div class="w-full bg-slate-300 rounded-full h-4 dark:bg-slate-700 mb-2">
                    <div id="progress-bar" class="bg-sky-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progress-bar-text" class="text-sm font-semibold text-slate-600 dark:text-slate-400">0%</p>
                <h2 id="loading-text" class="text-xl font-semibold mt-6">Generating Quiz...</h2>
                <p class="text-slate-500 dark:text-slate-400 mt-1">Please wait a moment.</p>
            </div>

            <!-- Quiz State -->
            <div id="quiz-state" class="hidden">
                <div class="relative flex justify-between items-center mb-4">
                    <button id="prev-question-btn" class="absolute left-0 p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h2 class="text-xl font-bold text-center w-full">Quiz Time!</h2>
                    <p id="progress-text" class="text-sm font-medium text-slate-500 dark:text-slate-400"></p>
                </div>
                <div id="question-container" class="fade-in">
                    <p id="question-text" class="text-lg font-semibold mb-4"></p>
                    <div id="options-container" class="grid grid-cols-1 gap-3">
                        <!-- Options will be dynamically inserted here -->
                    </div>
                </div>
                <p id="feedback-text" class="mt-4 font-semibold text-center"></p>
                <button id="next-question-btn" class="mt-6 w-full px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-sky-500 hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5 hidden">
                    Next Question
                </button>
            </div>

            <!-- Quiz Results State -->
            <div id="results-state" class="text-center p-8 hidden fade-in">
                <h2 class="text-2xl font-bold">Quiz Complete!</h2>
                <p id="score-text" class="text-4xl font-extrabold text-sky-500 dark:text-sky-400 my-4"></p>
                <p id="score-message" class="text-slate-500 dark:text-slate-400"></p>
                <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="review-answers-btn" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-sky-500 hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5">
                        Review Answers
                    </button>
                    <button id="retake-quiz-btn" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-800 hover:bg-indigo-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-700 transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5">
                        Retake Quiz
                    </button>
                    <button id="quiz-start-over-btn" class="sm:col-span-2 w-full inline-flex items-center justify-center px-6 py-3 border border-slate-300 dark:border-slate-500 text-base font-medium rounded-md shadow-sm text-slate-700 dark:text-slate-200 bg-white dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all">
                        Start Over
                    </button>
                </div>
            </div>
            
            <!-- Assignment Results State -->
            <div id="assignment-results-state" class="p-4 hidden fade-in">
                <h2 class="text-2xl font-bold text-center mb-4">Assignment Feedback</h2>
                <div id="assignment-feedback-container" class="border dark:border-slate-600"></div>
                <button id="assignment-start-over-btn" class="mt-8 w-full px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-sky-500 hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5">
                    Start Over
                </button>
            </div>

            <!-- Review State -->
            <div id="review-state" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Review Answers</h2>
                    <button id="back-to-results-btn" class="px-4 py-2 text-sm font-medium rounded-md text-slate-700 dark:text-slate-200 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors">
                        Back to Results
                    </button>
                </div>
                <div id="review-container" class="space-y-6 max-h-[70vh] overflow-y-auto pr-2">
                    <!-- Reviewed questions will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const uploadState = document.getElementById('upload-state');
        const loadingState = document.getElementById('loading-state');
        const quizState = document.getElementById('quiz-state');
        const resultsState = document.getElementById('results-state');
        const reviewState = document.getElementById('review-state');
        const reviewContainer = document.getElementById('review-container');
        const assignmentResultsState = document.getElementById('assignment-results-state');

        const imageUpload = document.getElementById('image-upload');
        const uploadButtonLabel = document.querySelector('label[for="image-upload"] span');
        const multiImagePreviewContainer = document.getElementById('multi-image-preview-container');
        const generateQuizBtn = document.getElementById('generate-quiz-btn');
        const checkAssignmentBtn = document.getElementById('check-assignment-btn');
        const uploadPrompt = document.getElementById('upload-prompt');
        const questionCountSelect = document.getElementById('question-count');
        const loadingText = document.getElementById('loading-text');
        const progressBar = document.getElementById('progress-bar');
        const progressBarText = document.getElementById('progress-bar-text');
        const customPrompt = document.getElementById('custom-prompt');
        
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackText = document.getElementById('feedback-text');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const progressText = document.getElementById('progress-text');
        
        const scoreText = document.getElementById('score-text');
        const scoreMessage = document.getElementById('score-message');
        const quizStartOverBtn = document.getElementById('quiz-start-over-btn');
        const retakeQuizBtn = document.getElementById('retake-quiz-btn');
        const reviewAnswersBtn = document.getElementById('review-answers-btn');
        const backToResultsBtn = document.getElementById('back-to-results-btn');
        
        const assignmentFeedbackContainer = document.getElementById('assignment-feedback-container');
        const assignmentStartOverBtn = document.getElementById('assignment-start-over-btn');

        // App State
        let imageDataArray = [];
        let quizData = [];
        let userAnswers = []; // To store the user's answers
        let currentQuestionIndex = 0;
        let score = 0;
        let progressInterval = null;
        
        // The API key is REMOVED from the client-side code for security.
        // It now lives in the Netlify environment variables.

        // Event Listeners
        imageUpload.addEventListener('change', handleImageUpload);
        generateQuizBtn.addEventListener('click', generateQuiz);
        checkAssignmentBtn.addEventListener('click', checkAssignment);
        nextQuestionBtn.addEventListener('click', showNextQuestion);
        prevQuestionBtn.addEventListener('click', showPreviousQuestion);
        quizStartOverBtn.addEventListener('click', resetApp);
        retakeQuizBtn.addEventListener('click', retakeQuiz);
        reviewAnswersBtn.addEventListener('click', showReview);
        backToResultsBtn.addEventListener('click', showResults);
        assignmentStartOverBtn.addEventListener('click', resetApp);

        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            // Clear previous images when new ones are selected
            // We don't clear here anymore, we clear before processing starts

            // Show loading state immediately for better UX while images are processed
            uploadState.classList.add('hidden');
            loadingState.classList.remove('hidden');
            loadingText.textContent = "Processing Images...";

            const filePromises = Array.from(files).map(file => resizeImage(file, 1024, 0.9));

            Promise.all(filePromises).then(processedImages => {
                processedImages.forEach(imgData => {
                    if (imgData) { // imgData is { thumbnailSrc, apiData, id }
                        imageDataArray.push(imgData);

                        // Create container for thumbnail and delete button
                        const thumbContainer = document.createElement('div');
                        thumbContainer.classList.add('thumbnail-container');
                        thumbContainer.dataset.imageId = imgData.id;

                        // Create image thumbnail
                        const img = document.createElement('img');
                        img.src = imgData.thumbnailSrc;
                        img.classList.add('thumbnail');
                        thumbContainer.appendChild(img);

                        // Create delete button
                        const deleteBtn = document.createElement('button');
                        // Use a modern SVG 'X' icon
                        deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" /></svg>`;
                        deleteBtn.classList.add('delete-btn');
                        deleteBtn.onclick = () => removeImage(imgData.id);
                        thumbContainer.appendChild(deleteBtn);

                        multiImagePreviewContainer.appendChild(thumbContainer);
                    }
                });

                // Hide loading and show the upload state with previews
                loadingState.classList.add('hidden');
                uploadState.classList.remove('hidden');

                multiImagePreviewContainer.classList.remove('hidden');
                multiImagePreviewContainer.classList.add('flex');
                checkAssignmentBtn.classList.remove('hidden');
                uploadPrompt.classList.add('hidden'); // This hides the initial prompt
                uploadButtonLabel.textContent = 'Add More Photos';

            }).catch(error => {
                console.error("Error processing images:", error);
                alert("There was an error processing your images. Please try again.");
                resetApp();
            });
        }

        function removeImage(imageId) {
            // Remove from state
            imageDataArray = imageDataArray.filter(img => img.id !== imageId);

            // Remove from DOM
            const thumbToRemove = multiImagePreviewContainer.querySelector(`[data-image-id="${imageId}"]`);
            if (thumbToRemove) {
                thumbToRemove.remove();
            }

            // If no images are left, revert to initial upload state
            if (imageDataArray.length === 0) {
                checkAssignmentBtn.classList.add('hidden');
                uploadPrompt.classList.remove('hidden');
                uploadButtonLabel.textContent = 'Add Photos';
            }
        }

        function commonApiSetup() {
             if (imageDataArray.length === 0) {
                alert('Please upload one or more images first.');
                return false;
            }
            // API key check is removed from here
            uploadState.classList.add('hidden');
            loadingState.classList.remove('hidden');
            startProgressBar();
            return true;
        }
        
        async function checkAssignment() {
            if (!commonApiSetup()) return;
            loadingText.textContent = "Checking Assignment...";
            
            const systemPrompt = `You are a helpful and encouraging tutor. Your task is to analyze the provided image(s) of a completed worksheet. For each question on the worksheet, provide the correct answer followed by a clear, easy-to-understand explanation. If the student's answer is visible and incorrect, gently point out the mistake in your explanation. The goal is to help the student learn the underlying concepts.

Format your response clearly. Respond only in plain text. Do not use any special formatting characters like Markdown or LaTeX (e.g., avoid using '$', '#', or '*').`;

            const userPrompt = `Please check this assignment and provide the correct answers with explanations.`;
            
            const parts = [ { text: userPrompt } ];
            imageDataArray.forEach(data => {
                parts.push({ inlineData: data.apiData });
            });

            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            try {
                // Call our secure Netlify function
                const responseText = await makeApiCall(payload);
                if (responseText) {
                    assignmentFeedbackContainer.textContent = responseText;
                    completeProgressBar();
                    loadingState.classList.add('hidden');
                    assignmentResultsState.classList.remove('hidden');
                } else {
                    throw new Error("The AI could not provide feedback for this assignment.");
                }
            } catch (error) {
                console.error("Error checking assignment:", error);
                alert(`Failed to check assignment. ${error.message}. Please try again.`);
                resetApp();
            }
        }

        async function generateQuiz(previousQuestions = null) {
            const promptText = customPrompt.value.trim();
            if (imageDataArray.length === 0 && !promptText) {
                alert('Please upload an image or type a quiz topic to begin.');
                return;
            }

            uploadState.classList.add('hidden');
            loadingState.classList.remove('hidden');
            startProgressBar();
            loadingText.textContent = "Generating Quiz...";
            
            const questionCount = questionCountSelect.value;

            let systemPrompt = `You are an expert curriculum designer. Your task is to analyze the provided images of a worksheet or study guide to understand the topics, concepts, and question formats. Based on this analysis, you must create a new set of multiple-choice questions that are *similar* in style and topic, but *not the same* as the ones in the images. The goal is to generate a fresh practice quiz that tests the same knowledge. The output must be a valid JSON object following this specific schema:
{"questions": [{"question": "...", "options": ["...", "...", "...", "..."], "answer": "..."}]}.
IMPORTANT: Each question MUST have exactly 4 options in the 'options' array. Ensure the 'answer' field exactly matches one of the strings in the 'options' array. All text in the question, options, and answer fields should be plain text, without any special formatting characters like Markdown or LaTeX (e.g., avoid using '$'). Synthesize information across all provided images if necessary. If no images are provided, generate the quiz based solely on the user's text prompt. Respond ONLY with the JSON object and nothing else.`;

            let userPrompt = promptText ? promptText : `Analyze the concepts in the following image(s).`;
            userPrompt += ` Generate a practice quiz with ${questionCount} questions.`;

            if (previousQuestions && previousQuestions.length > 0) {
                const oldQuestionsString = JSON.stringify(previousQuestions.map(q => q.question));
                userPrompt += ` IMPORTANT: The new questions must be different from the following previously asked questions: ${oldQuestionsString}`;
            }
            
            const parts = [ { text: userPrompt } ];
            imageDataArray.forEach(data => {
                parts.push({ inlineData: data.apiData });
            });

            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            
            try {
                // Call our secure Netlify function
                const responseText = await makeApiCall(payload);
                if (responseText) {
                    // The model might return the JSON wrapped in markdown or with extra text.
                    // We need to extract the raw JSON string before parsing.
                    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        console.error("Raw response from API:", responseText);
                        throw new Error("The AI response did not contain a valid JSON object.");
                    }
                    const jsonString = jsonMatch[0];
                    const parsedJson = JSON.parse(jsonString);
                    quizData = parsedJson.questions;
                    if (quizData && quizData.length > 0) {
                        completeProgressBar();
                        startQuiz();
                    } else {
                        throw new Error("The AI could not generate a quiz from this image.");
                    }
                } else {
                     throw new Error("Invalid response structure from API.");
                }

            } catch (error) {
                console.error("Error generating quiz:", error);
                alert(`Failed to generate quiz. ${error.message}. Please try a clearer image.`);
                resetApp();
            }
        }
        
        function retakeQuiz() {
            // Hide the results screen before generating the new quiz
            resultsState.classList.add('hidden');

            // Keep imageDataArray, but clear quiz-specific state
            const previousQuizData = [...quizData]; // Keep a copy of the old questions
            quizData = [];
            userAnswers = [];
            currentQuestionIndex = 0;
            score = 0;
            generateQuiz(previousQuizData); // Call generateQuiz with the old questions
        }

        function startProgressBar() {
            clearInterval(progressInterval); // Clear any existing interval
            let progress = 0;
            progressBar.style.width = '0%';
            progressBarText.textContent = '0%';

            progressInterval = setInterval(() => {
                // This logic makes the bar move fast at the start and slow down near the end
                if (progress < 60) {
                    progress += Math.random() * 5;
                } else if (progress < 90) {
                    progress += Math.random() * 2;
                } else if (progress < 99) {
                    progress += 0.1;
                }
                
                progress = Math.min(progress, 99); // Cap at 99% until complete
                progressBar.style.width = `${progress}%`;
                progressBarText.textContent = `${Math.floor(progress)}%`;
            }, 200);
        }

        function completeProgressBar() {
            clearInterval(progressInterval);
            progressInterval = null;
            progressBar.style.width = '100%';
            progressBarText.textContent = '100%';
        }
        
        async function makeApiCall(payload) {
             let response;
             let retries = 3;
             let delay = 1000;
             for (let i = 0; i < retries; i++) {
                 // The URL is now our Netlify Function endpoint
                 response = await fetch(`/.netlify/functions/generate`, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(payload)
                 });
                 if (response.ok) break;
                 console.warn(`Request failed with status ${response.status}. Retrying in ${delay}ms...`);
                 await new Promise(res => setTimeout(res, delay));
                 delay *= 2;
             }

             if (!response.ok) {
                 const errorBody = await response.json();
                 console.error("API call failed:", errorBody);
                 throw new Error(errorBody.error || `API request failed with status ${response.status}`);
            }
             
             const result = await response.json();
             // The structure of the response from our function matches Gemini's
             return result.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        function startQuiz() {
            loadingState.classList.add('hidden');
            quizState.classList.remove('hidden');
            currentQuestionIndex = 0;
            score = 0;
            displayQuestion();
        }

        function displayQuestion() {
            // Clear previous state
            optionsContainer.innerHTML = '';
            feedbackText.textContent = '';

            const question = quizData[currentQuestionIndex];
            const userAnswer = userAnswers[currentQuestionIndex];

            questionText.textContent = question.question;
            progressText.textContent = `Question ${currentQuestionIndex + 1} of ${quizData.length}`;

            // Update button visibility
            prevQuestionBtn.classList.toggle('hidden', currentQuestionIndex === 0);
            nextQuestionBtn.textContent = (currentQuestionIndex === quizData.length - 1) ? 'Finish Quiz' : 'Next Question';

            question.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('quiz-option', 'w-full', 'p-3', 'rounded-lg', 'border-2', 'border-slate-400', 'dark:border-slate-600', 'text-left', 'hover:bg-slate-100', 'dark:hover:bg-slate-700', 'transition-colors', 'duration-200');
                
                if (userAnswer !== undefined) { // If question has been answered
                    button.disabled = true;
                    if (option === question.answer) {
                        button.classList.add('correct');
                    }
                    if (option === userAnswer && userAnswer !== question.answer) {
                        button.classList.add('incorrect');
                    }
                } else { // New question
                    button.addEventListener('click', () => handleAnswer(button, option, question.answer));
                }
                optionsContainer.appendChild(button);
            });

            if (userAnswer !== undefined) {
                feedbackText.textContent = userAnswer === question.answer ? "Correct!" : `Incorrect. The correct answer was: ${question.answer}`;
                feedbackText.className = `mt-4 font-semibold text-center ${userAnswer === question.answer ? 'text-green-500' : 'text-red-500'}`;
                nextQuestionBtn.classList.remove('hidden');
            } else {
                nextQuestionBtn.classList.add('hidden');
            }

            document.getElementById('question-container').classList.remove('fade-in');
            void document.getElementById('question-container').offsetWidth; // Trigger reflow
            document.getElementById('question-container').classList.add('fade-in');
        }

        function handleAnswer(button, selectedOption, correctAnswer) {
            const buttons = optionsContainer.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);
            
            userAnswers[currentQuestionIndex] = selectedOption; // Store the answer

            if (selectedOption === correctAnswer) {
                score++;
                button.classList.add('correct');
                feedbackText.textContent = "Correct!";
                feedbackText.className = 'mt-4 font-semibold text-center text-green-500';
            } else {
                button.classList.add('incorrect');
                feedbackText.textContent = `Incorrect. The correct answer was: ${correctAnswer}`;
                feedbackText.className = 'mt-4 font-semibold text-center text-red-500';
                buttons.forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
            }
            
            nextQuestionBtn.classList.remove('hidden');
        }

        function showNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                displayQuestion();
            } else {
                showResults();
            }
        }

        function showPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function showReview() {
            resultsState.classList.add('hidden');
            reviewState.classList.remove('hidden');
            reviewContainer.innerHTML = ''; // Clear previous review

            quizData.forEach((question, index) => {
                const userAnswer = userAnswers[index] || "Not Answered"; // Handle case where a question might not be answered
                const correctAnswer = question.answer;
                const isCorrect = userAnswer === correctAnswer;

                const questionWrapper = document.createElement('div');
                questionWrapper.className = 'p-4 bg-white dark:bg-slate-700/50 rounded-lg shadow-sm';

                const questionTitle = document.createElement('p');
                questionTitle.className = 'font-semibold mb-3';
                questionTitle.textContent = `Q${index + 1}: ${question.question}`;
                questionWrapper.appendChild(questionTitle);

                const userAnswerDiv = document.createElement('div');
                userAnswerDiv.className = 'p-2 rounded-md text-sm flex items-center'; // Use flexbox for alignment

                let iconHtml = '';

                if (isCorrect) {
                    userAnswerDiv.classList.add('correct'); // This class is now styled differently in the review container
                    iconHtml = `<svg class="w-5 h-5 mr-2 flex-shrink-0 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>`;
                } else {
                    userAnswerDiv.classList.add('incorrect'); // This class is now styled differently in the review container
                    iconHtml = `<svg class="w-5 h-5 mr-2 flex-shrink-0 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                }
                
                userAnswerDiv.innerHTML = `${iconHtml}<div><span class="font-bold">Your Answer:</span> ${userAnswer}</div>`;
                questionWrapper.appendChild(userAnswerDiv);

                if (!isCorrect) {
                    const correctAnswerDiv = document.createElement('div');
                    correctAnswerDiv.className = 'p-2 rounded-md text-sm mt-2 correct'; // This uses the new 'correct' style
                    correctAnswerDiv.innerHTML = `<span class="font-bold">Correct Answer:</span> ${correctAnswer}`;
                    questionWrapper.appendChild(correctAnswerDiv);
                }

                reviewContainer.appendChild(questionWrapper);
            });

            // Scroll the review container to the top
            reviewContainer.scrollTop = 0;
        }

        function showResults() {
            quizState.classList.add('hidden');
            resultsState.classList.remove('hidden');
            scoreText.textContent = `${score} / ${quizData.length}`;
            const percentage = (score / quizData.length) * 100;
            if (percentage >= 80) {
                scoreMessage.textContent = "Great job! You aced it!";
            } else if (percentage >= 50) {
                scoreMessage.textContent = "Good effort! Keep practicing.";
            } else {
                scoreMessage.textContent = "Don't worry, try again!";
            }
            // Also ensure review state is hidden if we come back to results
            reviewState.classList.add('hidden');
        }
        
        function resetApp() {
            imageDataArray = [];
            quizData = [];
            userAnswers = [];
            currentQuestionIndex = 0;
            score = 0;
            clearInterval(progressInterval);

            multiImagePreviewContainer.innerHTML = '';
            multiImagePreviewContainer.classList.add('hidden');
            multiImagePreviewContainer.classList.remove('flex');
            assignmentFeedbackContainer.textContent = '';

            checkAssignmentBtn.classList.add('hidden');
            uploadPrompt.classList.remove('hidden');
            uploadButtonLabel.textContent = 'Add Photos';
            imageUpload.value = ''; 
            questionCountSelect.value = '10';
            customPrompt.value = '';

            resultsState.classList.add('hidden');
            assignmentResultsState.classList.add('hidden');
            reviewState.classList.add('hidden');
            loadingState.classList.add('hidden');
            quizState.classList.add('hidden');
            uploadState.classList.remove('hidden');
        }
    </script>

    <script>
        // Image Resizing Utility
        function resizeImage(file, maxSize, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxSize) {
                                height = Math.round((height * maxSize) / width);
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = Math.round((width * maxSize) / height);
                                height = maxSize;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        const dataUrl = canvas.toDataURL('image/jpeg', quality);
                        const match = dataUrl.match(/^data:(image\/\w+);base64,(.*)$/);
                        if (!match) return resolve(null);
                        
                        const uniqueId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                        resolve({ 
                            thumbnailSrc: dataUrl, 
                            apiData: { mimeType: match[1], data: match[2] },
                            id: uniqueId });
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
